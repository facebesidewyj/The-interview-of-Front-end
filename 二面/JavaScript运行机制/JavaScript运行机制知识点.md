# V8引擎是如何执行JS代码的

编程语言分为两个类型：

* 动态类型：只需要在运行时编译即可、如JavaScript、Python等，这个过程由解释器来完成
* 静态类型：需要提前编译成机器码执行，如C++、Go、Java等，这个过程由编译器来完成

V8引擎执行JS代码的过程：

* JS引擎会创建一个执行栈，将要执行的代码放入栈中

* 解析器Parser生成抽象语法树：Chrome在下载JavaScript文件之后就开启单独线程去解析代码，并生成AST
  * 词法分析：将字符流转化为token标记流
  * 语法分析：将token标记流按照语法规则生成AST语法树
* Ignition生成字节码：字节码是机器码的抽象，字节码比机器码占用的内存更小。字节码不能在处理器上直接运行，还需要转成机器码
* 执行代码并优化：执行字节码并记录执行次数，将重复执行的字节码提取并记录，提升复用效率

# V8引擎的垃圾回收机制

* 标记清除：垃圾回收器会给内存中的每个变量都增加一个标记，然后，它会去掉环境中的变量以及被环境中的变量引用的标记，剩下这些被标记的变量就是要进行回收的
* 引用计数：跟踪每个值被引用的次数，当引用次数为0时，就会被清除

# 线程与进程

线程：CPU调度的最小单位

进程：CPU资源分配的最小单位

线程与进程的关系：

* 一个进程可以由多个线程组成
* 一个进程的内存空间是共享的，多个线程可以共享这些内存空间

# 如何理解JS的单线程

当打开一个Tab页，可以说是创建了一个进程，这个进程包括渲染线程、JS执行线程、HTTP请求线程、音视频处理线程，其中JS引擎线程是处理JS代码的，JS是按照语句出现的顺序执行的，并且同一时间只能做一件事，保证了单个线程在执行时不被其他线程所打扰。比如：JavaScript代码处理DOM结构时，如果是多线程的，就会导致先后顺序的问题，为了避免引入线程锁，采用单线程执行。

# 什么是任务队列。

同步任务：主线程控制，根据语句出现的顺序一个接一个的顺序执行。

异步任务：进入Event Table并注册函数

# 什么是Event Loop

1. 同步和异步任务分别进入不同的"场所"，同步任务进入主线程，异步任务进入Event Table，并注册函数。
2. 当指定的事情完成时，Event Table会将这个函数移入Event Queue。
3. 主线程内的任务执行完毕，会去Event Queue读取对应函数，进入主线程执行。
4. 上述过程不断重复就形成了事件循环。

# Event Loop 过程解析

* 初始状态：调用栈为空，微任务队列为空，宏任务队列只有一个script脚本（整体代码）
* 全局上下文（script脚本）被推入调用栈，同步代码执行。执行过程中会产生新的宏任务和微任务，它们会被推入到各自的任务队列里。同步代码执行完毕，script脚本被移出宏任务队列
* 宏任务执行完毕后，会检查微任务队列，将队列中的微任务逐个执行完毕，直到队列清空。需要注意的是：**宏任务是一个一个执行的，微任务是一队一队执行的，微任务队列没有清空不会执行下一个宏任务**
* 执行渲染，更新界面
* 检查是否有Web Worker任务，如果有则进行处理
* 上述过程循环执行，直到所有队列都被清空
> 浏览器环境下，微任务队列是在宏任务执行完毕之后，批量执行。而在Node中，微任务会在事件循环的各个阶段去执行，也就是每一个阶段执行完毕，就会执行微任务。

# 哪些语句会被放入异步任务队列。

1. setTimeout和setInterval
2. DOM事件，注册事件时
3. ES6中的Promise
4. AJAX请求

# 放入异步任务队列的时机。

异步任务中的函数注册完成，并且执行了初始化的一些操作，以AJAX为例，当AJAX发送请求完成，success函数就进入了异步任务队列，等待主线程任务执行完毕，然后执行success回调函数。

# 宏任务与微任务

* 浏览器宏任务：I/O操作、setTimeout、setInterval、requestAnimationFrame
* 浏览器微任务：MutationObserver、Promise.then catch finally
* JS第一个要执行的宏任务是Script标签，之后会执行当前所有微任务
* 在当前微任务没有执行完成时，是不会执行下一个宏任务的
* 所有会进入的异步都是指的事件回调中的那部分代码

***script(主程序代码)—>process.nextTick—>Promises...——>setTimeout——>setInterval——>setImmediate——> I/O——>UI rendering***

>  宏任务和微任务是从另一个维度去定义JavaScript的任务队列，微任务存在的意义可能是浏览器不希望一些优先级高的任务等待一个完整事件循环周期再去执行，可能有些像银行柜台的VIP通道
